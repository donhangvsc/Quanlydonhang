import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, serverTimestamp } from 'firebase/firestore';
import { Download, Send, Plus, Trash2, Cloud, RefreshCw, Table, Settings, CheckCircle2 } from 'lucide-react';

const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'pos-gsheets-app';

export default function App() {
  const [user, setUser] = useState(null);
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [form, setForm] = useState({ name: '', qty: 1, price: '' });
  const [customer, setCustomer] = useState({ name: 'Khách lẻ' });
  const [sheetUrl, setSheetUrl] = useState(''); // URL Apps Script
  const [isSaving, setIsSaving] = useState(false);
  const [status, setStatus] = useState('');

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {}
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const itemsCol = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
    return onSnapshot(itemsCol, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setItems(data.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
      setLoading(false);
    });
  }, [user]);

  const addItem = async () => {
    if (!form.name || !form.price || !user) return;
    const itemsCol = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
    await addDoc(itemsCol, { ...form, qty: Number(form.qty), price: Number(form.price), createdAt: serverTimestamp() });
    setForm({ name: '', qty: 1, price: '' });
  };

  const removeItem = async (id) => {
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
  };

  // HÀM LƯU VÀO GOOGLE SHEETS
  const saveToSheets = async () => {
    if (!sheetUrl) {
      alert("Vui lòng dán URL Apps Script vào phần cài đặt!");
      return;
    }
    if (items.length === 0) return;

    setIsSaving(true);
    setStatus('Đang gửi dữ liệu...');

    try {
      const response = await fetch(sheetUrl, {
        method: 'POST',
        mode: 'no-cors', // Apps Script yêu cầu no-cors hoặc xử lý OPTIONS
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          customer: customer.name,
          items: items.map(i => ({ name: i.name, qty: i.qty, price: i.price }))
        })
      });

      setStatus('Đã lưu vào Google Sheets!');
      setTimeout(() => setStatus(''), 3000);
    } catch (error) {
      console.error(error);
      setStatus('Lỗi khi lưu!');
    } finally {
      setIsSaving(false);
    }
  };

  const totalAmount = items.reduce((sum, i) => sum + (i.qty * i.price), 0);

  return (
    <div className="min-h-screen bg-slate-50 flex justify-center pb-40">
      <div className="w-full max-w-md bg-white shadow-xl flex flex-col min-h-screen">
        
        <div className="bg-emerald-600 p-4 text-white shadow-md flex justify-between items-center">
          <div>
            <h1 className="font-bold flex items-center gap-2">POS TO SHEETS <Table size={16}/></h1>
            <p className="text-[10px] opacity-80">{user ? 'Đã kết nối trực tuyến' : 'Đang khởi tạo...'}</p>
          </div>
          <RefreshCw size={18} className={loading ? 'animate-spin' : ''} onClick={() => window.location.reload()} />
        </div>

        {/* Cài đặt URL Sheets */}
        <div className="p-3 bg-slate-100 border-b flex flex-col gap-2">
          <label className="text-[10px] font-bold text-slate-500 flex items-center gap-1 uppercase">
            <Settings size={10} /> Google Apps Script URL
          </label>
          <input 
            placeholder="Dán URL triển khai tại đây..." 
            className="text-[10px] p-2 rounded border w-full outline-none focus:ring-1 focus:ring-emerald-500"
            value={sheetUrl}
            onChange={(e) => setSheetUrl(e.target.value)}
          />
        </div>

        <div className="p-4 grid grid-cols-2 gap-3 border-b border-slate-100">
          <div>
            <label className="text-[10px] font-bold text-slate-400 uppercase">Khách hàng</label>
            <input className="w-full p-2 bg-slate-50 rounded border-none text-sm font-bold" value={customer.name} onChange={e => setCustomer({name: e.target.value})} />
          </div>
          <div className="flex flex-col justify-end text-right">
            {status && <span className="text-[10px] font-bold text-emerald-600 animate-pulse">{status}</span>}
          </div>
        </div>

        <div className="p-4 bg-emerald-50/50 space-y-3">
          <input placeholder="Tên sản phẩm..." className="w-full p-3 rounded-xl border-none shadow-sm text-sm" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />
          <div className="flex gap-2">
            <input type="number" placeholder="SL" className="w-1/4 p-3 rounded-xl border-none shadow-sm text-sm text-center" value={form.qty} onChange={e => setForm({...form, qty: e.target.value})} />
            <input type="number" placeholder="Đơn giá" className="w-3/4 p-3 rounded-xl border-none shadow-sm text-sm font-bold" value={form.price} onChange={e => setForm({...form, price: e.target.value})} />
          </div>
          <button onClick={addItem} className="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all text-sm uppercase">
            Thêm vào danh sách
          </button>
        </div>

        <div className="p-4 flex-1">
          {items.map((item) => (
            <div key={item.id} className="bg-white border-b border-slate-100 py-3 flex justify-between items-center">
              <div>
                <h4 className="font-bold text-slate-800 text-sm">{item.name}</h4>
                <p className="text-[10px] text-slate-500">{item.qty} x {new Intl.NumberFormat('vi-VN').format(item.price)}đ</p>
              </div>
              <div className="flex items-center gap-4">
                <span className="font-bold text-emerald-700 text-sm">{new Intl.NumberFormat('vi-VN').format(item.qty * item.price)}đ</span>
                <button onClick={() => removeItem(item.id)} className="text-slate-300"><Trash2 size={14}/></button>
              </div>
            </div>
          ))}
        </div>

        <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t p-4 shadow-2xl z-20">
          <div className="flex justify-between items-center mb-4">
            <span className="text-[10px] font-bold text-slate-400 uppercase">Tổng tiền đơn này</span>
            <span className="text-xl font-black text-emerald-600">{new Intl.NumberFormat('vi-VN').format(totalAmount)}đ</span>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <button 
              onClick={saveToSheets}
              disabled={isSaving || items.length === 0}
              className="flex flex-col items-center justify-center bg-emerald-700 py-3 rounded-2xl text-[10px] font-bold uppercase text-white shadow-lg active:scale-95 transition-all disabled:opacity-50"
            >
              <Table size={18} className="mb-1" /> {isSaving ? 'Đang lưu...' : 'Lưu vào Sheets'}
            </button>
            <button className="flex flex-col items-center justify-center bg-blue-600 py-3 rounded-2xl text-[10px] font-bold uppercase text-white shadow-lg active:scale-95 transition-all">
              <Send size={18} className="mb-1" /> Gửi Zalo
            </button>
          </div>
        </div>

      </div>
    </div>
  );
}


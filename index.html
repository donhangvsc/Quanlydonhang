<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>App B√°n H√†ng Pro - Zalo & Google Sheets</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel ƒë·ªÉ d·ªãch JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Th∆∞ vi·ªán ch·ª•p ·∫£nh m√†n h√¨nh -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Lucide Icons (D·∫°ng UMD cho tr√¨nh duy·ªát) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        /* ·∫®n thanh cu·ªôn nh∆∞ng v·∫´n cu·ªôn ƒë∆∞·ª£c */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .active-scale:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Icon Components ƒë∆°n gi·∫£n (SVG) ƒë·ªÉ ƒë·∫£m b·∫£o ch·∫°y ·ªïn ƒë·ªãnh kh√¥ng c·∫ßn import ph·ª©c t·∫°p
        const Icons = {
            ShoppingCart: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            PackageX: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14"/><path d="m7.5 4.27 9 5.15"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/><path d="m17 13 5 5m-5 0 5-5"/></svg>,
            Loader: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        };

        function App() {
            // --- STATE ---
            const [items, setItems] = useState([]);
            const [customer, setCustomer] = useState('Kh√°ch l·∫ª');
            const [customerNote, setCustomerNote] = useState('');
            const [form, setForm] = useState({ name: '', qty: 1, price: '' });
            const [sheetUrl, setSheetUrl] = useState('');
            
            const [isProcessingZalo, setIsProcessingZalo] = useState(false);
            const [isSavingSheet, setIsSavingSheet] = useState(false);
            const [notification, setNotification] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            
            const receiptRef = useRef(null);

            // Load URL v√† items t·ª´ LocalStorage khi m·ªü app
            useEffect(() => {
                const savedUrl = localStorage.getItem('POS_SHEET_URL');
                if (savedUrl) setSheetUrl(savedUrl);
            }, []);

            // Th√¥ng b√°o
            const showNotification = (message, type = 'success') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 3000);
            };

            // Logic b√°n h√†ng
            const addItem = () => {
                if (!form.name || !form.price) {
                    showNotification('Thi·∫øu t√™n ho·∫∑c gi√°!', 'error');
                    return;
                }
                const newItem = {
                    id: Date.now(),
                    name: form.name,
                    qty: Number(form.qty),
                    price: Number(form.price),
                };
                setItems([...items, newItem]);
                setForm({ name: '', qty: 1, price: '' });
                if (navigator.vibrate) navigator.vibrate(50);
            };

            const removeItem = (id) => setItems(items.filter(item => item.id !== id));
            const totalAmount = items.reduce((sum, item) => sum + (item.qty * item.price), 0);
            const formattedTotal = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(totalAmount);

            // --- L∆ØU GOOGLE SHEETS ---
            const handleSaveToSheet = async () => {
                if (items.length === 0) return showNotification('ƒê∆°n h√†ng tr·ªëng!', 'error');
                if (!sheetUrl) {
                    setShowSettings(true);
                    return showNotification('C·∫ßn nh·∫≠p URL Google Sheets!', 'error');
                }

                setIsSavingSheet(true);
                try {
                    await fetch(sheetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            customer: customer,
                            note: customerNote,
                            total: totalAmount,
                            items: items.map(i => ({ name: i.name, qty: i.qty, price: i.price }))
                        })
                    });
                    showNotification('‚úÖ ƒê√£ l∆∞u v√†o Google Sheets!');
                } catch (error) {
                    showNotification('L·ªói k·∫øt n·ªëi m·∫°ng!', 'error');
                } finally {
                    setIsSavingSheet(false);
                }
            };

            // --- XU·∫§T ·∫¢NH & G·ª¨I ZALO ---
            const handleZaloShare = async () => {
                if (items.length === 0) return showNotification('ƒê∆°n h√†ng tr·ªëng!', 'error');
                setIsProcessingZalo(true);
                showNotification('ƒêang t·∫°o ·∫£nh h√≥a ƒë∆°n...', 'info');

                try {
                    const element = receiptRef.current;
                    element.style.display = 'block';
                    
                    const canvas = await window.html2canvas(element, {
                        scale: 3, useCORS: true, backgroundColor: '#ffffff', logging: false,
                    });
                    
                    element.style.display = 'none';
                    const imageUri = canvas.toDataURL('image/png');

                    // T·∫£i ·∫£nh v·ªÅ
                    const link = document.createElement('a');
                    link.href = imageUri;
                    link.download = `DonHang_${customer.replace(/\s+/g, '_')}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showNotification('üì∏ ƒê√£ l∆∞u ·∫£nh! ƒêang m·ªü Zalo...');
                    
                    setTimeout(() => {
                        window.location.href = 'zalo://';
                        setTimeout(() => {
                            if (document.hasFocus()) window.open("https://chat.zalo.me/", "_blank");
                        }, 1500);
                    }, 1000);

                } catch (error) {
                    showNotification('L·ªói t·∫°o ·∫£nh!', 'error');
                } finally {
                    setIsProcessingZalo(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans pb-40 select-none relative">
                    
                    {/* Notification Toast */}
                    {notification && (
                        <div className={`fixed top-5 left-1/2 -translate-x-1/2 z-[60] px-6 py-3 rounded-full shadow-2xl flex items-center gap-2 animate-bounce whitespace-nowrap ${notification.type === 'error' ? 'bg-red-500 text-white' : 'bg-emerald-600 text-white'}`}>
                            {notification.type === 'error' ? <Icons.PackageX /> : <Icons.CheckCircle />}
                            <span className="text-sm font-bold">{notification.message}</span>
                        </div>
                    )}

                    {/* Header */}
                    <div className="bg-blue-700 text-white p-5 rounded-b-[2rem] shadow-xl sticky top-0 z-20 flex justify-between items-center">
                        <div>
                            <h1 className="text-xl font-black flex items-center gap-2 uppercase italic tracking-tighter">
                                <Icons.ShoppingCart /> POS Pro
                            </h1>
                            <span className="text-[10px] font-bold opacity-70 bg-blue-800 px-2 py-0.5 rounded-full">Zalo & Sheets Integration</span>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="p-2 bg-blue-600 rounded-full hover:bg-blue-500 transition-colors shadow-lg active-scale">
                            <Icons.Settings />
                        </button>
                    </div>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
                            <div className="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-slate-800 uppercase tracking-wide">C√†i ƒë·∫∑t k·∫øt n·ªëi</h3>
                                    <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-red-500"><Icons.X /></button>
                                </div>
                                <div className="space-y-3">
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 uppercase block mb-1">URL Google Apps Script</label>
                                        <textarea 
                                            className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs h-24 focus:ring-2 focus:ring-blue-500 outline-none font-mono"
                                            placeholder="https://script.google.com/macros/s/..."
                                            value={sheetUrl}
                                            onChange={(e) => {
                                                setSheetUrl(e.target.value);
                                                localStorage.setItem('POS_SHEET_URL', e.target.value);
                                            }}
                                        />
                                    </div>
                                </div>
                                <button onClick={() => setShowSettings(false)} className="w-full mt-5 bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg active-scale">L∆∞u c√†i ƒë·∫∑t</button>
                            </div>
                        </div>
                    )}

                    <div className="max-w-md mx-auto p-4 space-y-4">
                        {/* Kh√°ch h√†ng */}
                        <div className="bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                            <div className="space-y-3">
                                <input
                                    type="text" placeholder="T√™n kh√°ch h√†ng" value={customer}
                                    onChange={(e) => setCustomer(e.target.value)}
                                    className="w-full p-3 bg-slate-50 rounded-xl font-bold text-slate-800 focus:bg-white focus:ring-2 focus:ring-blue-400 outline-none transition-all"
                                />
                                <input
                                    type="text" placeholder="Ghi ch√∫ (SƒêT/ƒê·ªãa ch·ªâ)" value={customerNote}
                                    onChange={(e) => setCustomerNote(e.target.value)}
                                    className="w-full p-3 bg-slate-50 rounded-xl text-sm text-slate-600 focus:bg-white focus:ring-2 focus:ring-blue-400 outline-none transition-all"
                                />
                            </div>
                        </div>

                        {/* Nh·∫≠p h√†ng */}
                        <div className="bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                            <div className="space-y-3">
                                <input
                                    type="text" placeholder="T√™n s·∫£n ph·∫©m..." value={form.name}
                                    onChange={(e) => setForm({ ...form, name: e.target.value })}
                                    className="w-full p-3 bg-slate-50 rounded-xl font-medium focus:bg-white focus:ring-2 focus:ring-blue-400 outline-none"
                                />
                                <div className="flex gap-3">
                                    <input
                                        type="number" placeholder="SL" min="1" value={form.qty}
                                        onChange={(e) => setForm({ ...form, qty: e.target.value })}
                                        className="w-1/3 p-3 bg-slate-50 rounded-xl font-bold text-center focus:bg-white focus:ring-2 focus:ring-blue-400 outline-none"
                                    />
                                    <input
                                        type="number" placeholder="ƒê∆°n gi√°" value={form.price}
                                        onChange={(e) => setForm({ ...form, price: e.target.value })}
                                        className="w-2/3 p-3 bg-slate-50 rounded-xl font-bold text-blue-600 focus:bg-white focus:ring-2 focus:ring-blue-400 outline-none"
                                    />
                                </div>
                                <button onClick={addItem} className="w-full bg-slate-800 text-white font-bold p-3 rounded-xl flex items-center justify-center gap-2 active-scale shadow-lg">
                                    <Icons.Plus /> Th√™m m√≥n
                                </button>
                            </div>
                        </div>

                        {/* Danh s√°ch */}
                        <div className="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 min-h-[150px]">
                            <div className="flex justify-between items-center mb-3">
                                <h2 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">ƒê∆°n h√†ng hi·ªán t·∫°i</h2>
                                <span className="bg-slate-100 px-2 py-1 rounded text-[10px] font-bold text-slate-500">{items.length} m√≥n</span>
                            </div>
                            {items.length === 0 ? (
                                <div className="text-center py-8 text-slate-300 italic text-sm">Ch∆∞a c√≥ m√≥n n√†o</div>
                            ) : (
                                <div className="space-y-2">
                                    {items.map((item) => (
                                        <div key={item.id} className="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border border-slate-100 animate-[fadeIn_0.3s_ease-out]">
                                            <div>
                                                <h4 className="font-bold text-slate-800 text-sm">{item.name}</h4>
                                                <div className="text-[10px] text-slate-500 font-bold">
                                                    {item.qty} x {new Intl.NumberFormat('vi-VN').format(item.price)}
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className="font-bold text-blue-700 text-sm">{new Intl.NumberFormat('vi-VN').format(item.qty * item.price)}</span>
                                                <button onClick={() => removeItem(item.id)} className="text-slate-400 hover:text-red-500 bg-white p-2 rounded-xl border border-slate-200 active-scale"><Icons.Trash2 /></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Footer */}
                    <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white p-5 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] rounded-t-[32px] z-40 border-t border-slate-50">
                        <div className="flex justify-between items-end mb-4 px-2">
                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">T·ªïng ti·ªÅn</span>
                            <span className="text-3xl font-black text-blue-700 leading-none">{formattedTotal}</span>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <button 
                                onClick={handleSaveToSheet}
                                disabled={isSavingSheet}
                                className={`flex items-center justify-center gap-2 font-bold py-3.5 rounded-2xl border-2 active-scale transition-transform ${isSavingSheet ? 'bg-emerald-50 text-emerald-800 border-emerald-100' : 'bg-white text-emerald-600 border-emerald-100'}`}
                            >
                                {isSavingSheet ? <Icons.Loader /> : <Icons.Save />} 
                                <span className="text-xs uppercase font-black">{isSavingSheet ? 'ƒêang l∆∞u...' : 'L∆∞u Sheets'}</span>
                            </button>
                            
                            <button 
                                onClick={handleZaloShare}
                                disabled={isProcessingZalo}
                                className={`flex items-center justify-center gap-2 font-bold py-3.5 rounded-2xl shadow-xl shadow-blue-200 active-scale transition-all ${isProcessingZalo ? 'bg-slate-400 text-white cursor-not-allowed' : 'bg-[#0068ff] text-white'}`}
                            >
                                {isProcessingZalo ? <Icons.Loader /> : <Icons.Send />} 
                                <span className="text-xs uppercase font-black">{isProcessingZalo ? 'T·∫°o ·∫£nh...' : 'G·ª≠i Zalo'}</span>
                            </button>
                        </div>
                    </div>

                    {/* INVOICE HIDDEN */}
                    <div ref={receiptRef} style={{ display: 'none', position: 'fixed', top: 0, left: 0, zIndex: -1, width: '500px', padding: '40px', backgroundColor: 'white', color: '#000', fontFamily: 'Arial, sans-serif' }}>
                        <div style={{textAlign: 'center', borderBottom: '3px solid #000', paddingBottom: '15px', marginBottom: '20px'}}>
                            <h1 style={{fontSize: '28px', fontWeight: '900', textTransform: 'uppercase', margin: 0}}>H√ìA ƒê∆†N B√ÅN L·∫∫</h1>
                            <p style={{fontSize: '14px', color: '#555', marginTop: '5px'}}>{new Date().toLocaleString('vi-VN')}</p>
                        </div>
                        <div style={{marginBottom: '20px'}}>
                            <p style={{margin: '5px 0', fontSize: '16px'}}><strong>Kh√°ch:</strong> {customer}</p>
                            {customerNote && <p style={{margin: '5px 0', fontSize: '14px', fontStyle: 'italic'}}>Ghi ch√∫: {customerNote}</p>}
                        </div>
                        <table style={{width: '100%', borderCollapse: 'collapse', marginBottom: '20px'}}>
                            <thead>
                                <tr style={{borderBottom: '2px solid #000', fontSize: '14px', textTransform: 'uppercase'}}>
                                    <th style={{textAlign: 'left', padding: '10px 0'}}>M√≥n</th>
                                    <th style={{textAlign: 'center'}}>SL</th>
                                    <th style={{textAlign: 'right'}}>ƒê.Gi√°</th>
                                    <th style={{textAlign: 'right'}}>T·ªïng</th>
                                </tr>
                            </thead>
                            <tbody>
                                {items.map((item, index) => (
                                    <tr key={index} style={{borderBottom: '1px dotted #ccc'}}>
                                        <td style={{padding: '12px 0', fontWeight: '500'}}>{item.name}</td>
                                        <td style={{textAlign: 'center'}}>{item.qty}</td>
                                        <td style={{textAlign: 'right'}}>{new Intl.NumberFormat('vi-VN').format(item.price)}</td>
                                        <td style={{textAlign: 'right', fontWeight: 'bold'}}>{new Intl.NumberFormat('vi-VN').format(item.qty * item.price)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        <div style={{textAlign: 'right', borderTop: '3px solid #000', paddingTop: '15px'}}>
                            <p style={{fontSize: '32px', fontWeight: '900', color: '#0068ff', margin: 0}}>{formattedTotal}</p>
                        </div>
                        <div style={{textAlign: 'center', marginTop: '40px', fontSize: '12px', color: '#999'}}>C·∫£m ∆°n qu√Ω kh√°ch!</div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
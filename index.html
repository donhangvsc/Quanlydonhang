<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e40af">
    
    <title>Khánh Cường Cát Tường - POS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-blue: #1e40af;
            --secondary-blue: #3b82f6;
            --bg-gradient: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }
        body { 
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-gradient);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            color: #1e293b;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.1);
        }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .btn-fancy {
            background: linear-gradient(to right, #1e40af, #3b82f6);
            transition: all 0.2s ease;
        }
        .btn-fancy:active { transform: scale(0.96); brightness: 1.1; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input:focus { border-color: #3b82f6 !important; }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-up { animation: slideUp 0.4s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        const Icons = {
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14M5 12h14"/></svg>,
            Trash: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/></svg>,
            Send: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            Save: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>,
            Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        };

        function App() {
            const [items, setItems] = useState([]);
            const [customer, setCustomer] = useState('Khách lẻ');
            const [customerNote, setCustomerNote] = useState('');
            const [form, setForm] = useState({ name: '', qty: 1, price: '', promo: '' });
            const [sheetUrl, setSheetUrl] = useState(localStorage.getItem('POS_SHEET_URL_KIND') || '');
            const [showSettings, setShowSettings] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [notif, setNotif] = useState(null);
            const receiptRef = useRef(null);

            const showNotif = (msg) => {
                setNotif(msg);
                setTimeout(() => setNotif(null), 3000);
            }

            const addItem = () => {
                if (!form.name || !form.price) return;
                setItems([{ id: Date.now(), ...form, price: Number(form.price), qty: Number(form.qty) }, ...items]);
                setForm({ name: '', qty: 1, price: '', promo: '' });
                if (window.navigator.vibrate) window.navigator.vibrate(50);
            };

            const total = items.reduce((s, i) => s + (i.price * i.qty), 0);

            const handleZalo = async () => {
                if (items.length === 0) return;
                setIsLoading(true);
                try {
                    const canvas = await html2canvas(receiptRef.current, { scale: 3, backgroundColor: '#fff' });
                    const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
                    const file = new File([blob], `Khánh_Cường_Don_Hang.png`, { type: 'image/png' });

                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({ files: [file], title: 'Gửi hóa đơn Khánh Cường Cát Tường' });
                    } else {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL();
                        link.download = `HoaDon_KhanhCuong.png`;
                        link.click();
                        showNotif("Đã lưu ảnh! Hãy mở Zalo gửi cho khách.");
                        setTimeout(() => window.location.href = "zalo://", 1000);
                    }
                } catch (e) { showNotif("Lỗi khi tạo ảnh!"); }
                setIsLoading(false);
            };

            const saveSheet = async () => {
                if (!sheetUrl) return setShowSettings(true);
                setIsLoading(true);
                try {
                    await fetch(sheetUrl, {
                        method: 'POST', mode: 'no-cors',
                        body: JSON.stringify({ customer, note: customerNote, total, items, brand: "Khánh Cường Cát Tường" })
                    });
                    showNotif("✅ Đã lưu đơn hàng vào Google Sheets!");
                } catch (e) { showNotif("Lỗi kết nối bảng tính!"); }
                setIsLoading(false);
            };

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto overflow-hidden shadow-2xl relative">
                    
                    {/* Toast */}
                    {notif && (
                        <div className="fixed top-24 left-1/2 -translate-x-1/2 z-[100] bg-blue-900/90 text-white text-xs font-bold px-8 py-3 rounded-full shadow-2xl backdrop-blur-md animate-bounce border border-blue-400/30">
                            {notif}
                        </div>
                    )}

                    {/* Header */}
                    <div className="safe-top bg-gradient-to-br from-blue-900 via-blue-800 to-blue-700 text-white px-6 pb-8 rounded-b-[3rem] shadow-2xl flex justify-between items-end h-36">
                        <div className="animate-up">
                            <h1 className="text-2xl font-black tracking-tighter uppercase italic leading-none">Khánh Cường</h1>
                            <p className="text-sm font-light tracking-[0.2em] opacity-80 uppercase">Cát Tường</p>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="p-3 bg-white/10 rounded-2xl btn-fancy border border-white/20 shadow-lg">
                            <Icons.Settings />
                        </button>
                    </div>

                    {/* Content Area */}
                    <div className="flex-1 overflow-y-auto px-5 py-6 space-y-5 no-scrollbar">
                        
                        {/* Customer Info */}
                        <div className="glass-card p-5 rounded-[2rem] space-y-3 animate-up" style={{animationDelay: '0.1s'}}>
                            <div className="relative">
                                <label className="text-[10px] font-black text-blue-800/40 uppercase absolute -top-2 left-3 bg-white px-2">Khách hàng</label>
                                <input 
                                    className="w-full text-lg font-black text-blue-900 bg-transparent border-2 border-blue-50 p-3 rounded-2xl focus:border-blue-300 outline-none transition-all"
                                    value={customer}
                                    onChange={(e) => setCustomer(e.target.value)}
                                />
                            </div>
                            <div className="relative">
                                <label className="text-[10px] font-black text-blue-800/40 uppercase absolute -top-2 left-3 bg-white px-2">Ghi chú</label>
                                <input 
                                    className="w-full text-xs text-slate-500 bg-transparent border border-blue-50 p-3 rounded-xl italic focus:border-blue-200 outline-none"
                                    value={customerNote}
                                    onChange={(e) => setCustomerNote(e.target.value)}
                                    placeholder="SĐT, địa chỉ hoặc yêu cầu riêng..."
                                />
                            </div>
                        </div>

                        {/* Product Input */}
                        <div className="glass-card p-5 rounded-[2rem] space-y-4 animate-up" style={{animationDelay: '0.2s'}}>
                            <input 
                                className="w-full p-4 bg-blue-50/50 rounded-2xl text-sm font-bold border border-transparent focus:bg-white focus:shadow-inner outline-none transition-all"
                                placeholder="Tên sản phẩm..."
                                value={form.name}
                                onChange={(e) => setForm({...form, name: e.target.value})}
                            />
                            <input 
                                className="w-full p-3 bg-blue-50/30 rounded-xl text-[11px] italic border border-transparent focus:bg-white outline-none"
                                placeholder="Chương trình khuyến mãi / Quà tặng..."
                                value={form.promo}
                                onChange={(e) => setForm({...form, promo: e.target.value})}
                            />
                            <div className="flex gap-3">
                                <div className="w-24">
                                    <input 
                                        type="number" className="w-full p-4 bg-blue-50/50 rounded-2xl text-center font-black text-blue-900 outline-none"
                                        value={form.qty}
                                        onChange={(e) => setForm({...form, qty: e.target.value})}
                                        placeholder="SL"
                                    />
                                </div>
                                <div className="flex-1">
                                    <input 
                                        type="number" className="w-full p-4 bg-blue-50/50 rounded-2xl font-black text-blue-700 outline-none"
                                        value={form.price}
                                        onChange={(e) => setForm({...form, price: e.target.value})}
                                        placeholder="Đơn giá"
                                    />
                                </div>
                                <button onClick={addItem} className="btn-fancy text-white px-6 rounded-2xl shadow-xl shadow-blue-200 flex items-center justify-center">
                                    <Icons.Plus />
                                </button>
                            </div>
                        </div>

                        {/* Items List */}
                        <div className="space-y-3 pb-24">
                            <h3 className="text-[10px] font-black text-blue-900/30 uppercase tracking-[0.3em] ml-2">Danh sách đơn hàng</h3>
                            {items.length === 0 ? (
                                <div className="text-center py-10 opacity-20 grayscale font-black text-sm uppercase italic">Đơn hàng trống</div>
                            ) : (
                                items.map(item => (
                                    <div key={item.id} className="glass-card p-4 rounded-3xl flex justify-between items-start animate-up border-l-4 border-l-blue-600">
                                        <div className="flex-1">
                                            <h4 className="font-black text-blue-900 text-sm leading-tight uppercase">{item.name}</h4>
                                            {item.promo && <p className="text-[10px] text-blue-500 font-bold italic mt-1 leading-tight">✦ {item.promo}</p>}
                                            <p className="text-[10px] font-black text-slate-400 mt-2 bg-slate-100 w-fit px-2 py-1 rounded-lg">
                                                {item.qty} x {item.price.toLocaleString()}đ
                                            </p>
                                        </div>
                                        <div className="flex flex-col items-end gap-3 ml-2">
                                            <span className="font-black text-blue-700 text-base italic leading-none">{(item.qty * item.price).toLocaleString()}đ</span>
                                            <button onClick={() => setItems(items.filter(i => i.id !== item.id))} className="text-slate-200 active:text-red-500 transition-colors">
                                                <Icons.Trash />
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    {/* Bottom Payment Bar */}
                    <div className="absolute bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl px-6 pt-6 pb-10 border-t border-blue-50 rounded-t-[3rem] shadow-[0_-20px_50px_rgba(30,64,175,0.1)]">
                        <div className="flex justify-between items-center mb-6 px-2">
                            <div>
                                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest block">Thành tiền</span>
                                <span className="text-3xl font-black text-blue-900 italic">{total.toLocaleString()}<small className="text-sm ml-1 not-italic">đ</small></span>
                            </div>
                            <div className="text-right">
                                <span className="text-[10px] font-black text-blue-400 uppercase block">{items.length} món</span>
                                <span className="text-[10px] font-bold text-slate-300 uppercase">Khánh Cường POS</span>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={saveSheet} className="flex items-center justify-center gap-2 bg-blue-50 text-blue-800 font-black py-4 rounded-2xl btn-active border border-blue-100">
                                <Icons.Save /> <span className="text-[11px] uppercase tracking-wider">Lưu Bảng Tính</span>
                            </button>
                            <button onClick={handleZalo} className="flex items-center justify-center gap-2 btn-fancy text-white font-black py-4 rounded-2xl shadow-2xl shadow-blue-300">
                                <Icons.Send /> <span className="text-[11px] uppercase tracking-wider">Gửi Zalo</span>
                            </button>
                        </div>
                    </div>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 z-[120] bg-blue-950/40 backdrop-blur-md flex items-end">
                            <div className="bg-white w-full p-8 rounded-t-[3rem] shadow-2xl animate-up">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-black text-blue-900 uppercase italic">Cấu hình kết nối</h3>
                                    <button onClick={() => setShowSettings(false)} className="rotate-45 p-2 bg-slate-100 rounded-full"><Icons.Plus/></button>
                                </div>
                                <p className="text-[10px] font-bold text-slate-400 mb-2 uppercase">Google Apps Script URL</p>
                                <textarea 
                                    className="w-full p-4 bg-slate-50 rounded-2xl text-[10px] h-28 outline-none border border-slate-100 focus:ring-2 focus:ring-blue-500 font-mono"
                                    value={sheetUrl}
                                    onChange={(e) => { setSheetUrl(e.target.value); localStorage.setItem('POS_SHEET_URL_KIND', e.target.value); }}
                                    placeholder="https://script.google.com/macros/s/..."
                                />
                                <button onClick={() => setShowSettings(false)} className="w-full mt-6 btn-fancy text-white font-black py-4 rounded-2xl shadow-xl">ÁP DỤNG CÀI ĐẶT</button>
                            </div>
                        </div>
                    )}

                    {/* RECEIPT FOR SNAPSHOT */}
                    <div className="fixed -left-[3000px] top-0">
                        <div ref={receiptRef} className="w-[500px] p-12 bg-white text-slate-900 font-sans border-[20px] border-blue-900">
                            <div className="text-center mb-10">
                                <h1 className="text-4xl font-black text-blue-900 italic uppercase mb-1">Khánh Cường</h1>
                                <h2 className="text-xl font-light tracking-[0.5em] text-blue-700 uppercase mb-4">Cát Tường</h2>
                                <div className="h-1 w-20 bg-blue-900 mx-auto mb-4"></div>
                                <p className="text-sm opacity-50 italic uppercase font-bold tracking-widest">{new Date().toLocaleString('vi-VN')}</p>
                            </div>
                            
                            <div className="mb-8 space-y-2 border-l-4 border-blue-900 pl-4 py-2 bg-blue-50/30">
                                <p className="text-xl"><strong>Khách hàng:</strong> <span className="uppercase font-black text-blue-900">{customer}</span></p>
                                {customerNote && <p className="text-sm italic 